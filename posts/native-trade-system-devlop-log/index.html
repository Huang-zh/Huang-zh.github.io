<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="[huangzh]">
<meta name="description" content="随着云交易系统的建设，陆续更新过程中的开发日志、遇到的问题以及解决方案。" />
<meta name="keywords" content=", 交易系统开发日志" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://lemonhuang.com/posts/native-trade-system-devlop-log/" />
<link rel="icon" type="image/png" href="/static/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
<link rel="manifest" href="/static/site.webmanifest" />


    <title>
        
            云交易系统开发手册 :: 此间的少年 
        
    </title>





<link rel="stylesheet" href="/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css" integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="云交易系统开发手册">
<meta itemprop="description" content="随着云交易系统的建设，陆续更新过程中的开发日志、遇到的问题以及解决方案。"><meta itemprop="datePublished" content="2024-03-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-03-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="14078"><meta itemprop="image" content="https://lemonhuang.com"/>
<meta itemprop="keywords" content="交易系统开发日志," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lemonhuang.com"/>

<meta name="twitter:title" content="云交易系统开发手册"/>
<meta name="twitter:description" content="随着云交易系统的建设，陆续更新过程中的开发日志、遇到的问题以及解决方案。"/>



    <meta property="og:title" content="云交易系统开发手册" />
<meta property="og:description" content="随着云交易系统的建设，陆续更新过程中的开发日志、遇到的问题以及解决方案。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lemonhuang.com/posts/native-trade-system-devlop-log/" /><meta property="og:image" content="https://lemonhuang.com"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-03-02T00:00:00+00:00" /><meta property="og:site_name" content="此间的少年" />






    <meta property="article:section" content="交易系统开发日志" />



    <meta property="article:published_time" content="2024-03-02 00:00:00 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                huan.g</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/posts/">文章</a></li><li><a href="/categories/">分类</a></li><li><a href="/about/">关于</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>



            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        29分钟

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://lemonhuang.com/posts/native-trade-system-devlop-log/">云交易系统开发手册</a>
      </h1>

      
        <div class="post-excerpt">随着云交易系统的建设，陆续更新过程中的开发日志、遇到的问题以及解决方案。</div>
      

      

      

      <div class="post-content">
        <h3 id="1-依赖和中间件">1. 依赖和中间件</h3>
<ul>
<li>open-jdk 17.0.7</li>
<li>graalvm 22.3.2</li>
<li>Maven 3.6.3</li>
<li>nacos 2.2.3</li>
<li>Redis 6.0</li>
<li>Mysql 8.0</li>
<li>Springboot 3.0.6</li>
<li>SpringCloud Alibaba 2022.0.0.0</li>
<li>mybatis-plus 3.5.3</li>
<li>Seata 1.7.0</li>
<li>Netty 4.1.99</li>
<li>Disruptor 4.0.0</li>
</ul>
<h3 id="2-模块总览">2. 模块总览</h3>
<table>
<thead>
<tr>
<th style="text-align:center">模块名</th>
<th style="text-align:center">中文名</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">native-cloud-user-system</td>
<td style="text-align:center">交易账户系统</td>
<td style="text-align:center">用于维护证券交易账户数据，负责客户开户、适当性、风险评估等常规运营操作。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-qms-system</td>
<td style="text-align:center">交易额度系统</td>
<td style="text-align:center">用于维护日间交易信用业务头寸、申报流水号区间等交易关键辅助信息。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-compact</td>
<td style="text-align:center">信用合约系统</td>
<td style="text-align:center">用于维护日间信用交易产生的合约信息，提供对合约进行清算、展期、结息罚息等操作。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-credit-trade</td>
<td style="text-align:center">信用交易系统</td>
<td style="text-align:center">提供日间融资融券业务入口，供信用客户进行融资融券日间交易。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-gateway</td>
<td style="text-align:center">交易网关</td>
<td style="text-align:center">所有日间交易、运营业务的入口，后续将建设包含根据具体账户定位至具体交易核心的功能，实现多分片定位。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-system-api</td>
<td style="text-align:center">交易交互组件</td>
<td style="text-align:center">包含各交易子系统相互调用的api、数据载体。</td>
</tr>
<tr>
<td style="text-align:center">native-cloud-common</td>
<td style="text-align:center">交易通用组件</td>
<td style="text-align:center">包含交易子系统公用工具类、配置类等关键可插拔功能的启动项。</td>
</tr>
</tbody>
</table>
<h4 id="21-模块简介">2.1 模块简介</h4>
<p>todo&hellip;</p>
<h3 id="3-部署事项">3. 部署事项</h3>
<h4 id="31-部署命令">3.1 部署命令：</h4>
<ul>
<li>
<p>建议每个模块都在idea中添加两个启动配置项</p>
<ul>
<li>Native-cloud-xxx-debug：用于本地idea调试功能使用</li>
<li>Native-cloud-xxx-preCompile：用于Native打包镜像，需要添加VM参数命令：
<ul>
<li>-agentlib:native-image-agent=config-output-dir=/你的idea workspace目录/native-cloud-system/native-cloud-xxx-system/src/main/resources/META-INF/native-image/native-cloud-xxx-system</li>
<li>添加VM参数启动后，随机通过调试请求工具（如postman）访问该模块子系统几个功能（也可以不做这一步，只是为了确保native-image打包时所有代码组件均能够被链接），然后停止该模块，会在该模块的src/main/resources/META-INF/native-image/native-cloud-xxx-system目录下生成打包所需的json配置文件，这些文件中指定了源代码中通过反射、代理等途径创建的对象，只有成功生成这些配置文件，native-image打包成本地镜像才不会报错。</li>
</ul>
</li>
<li>native-image执行打包命令：
<ul>
<li>mvn -e -Pnative -DskipTests=true native:compile</li>
</ul>
</li>
</ul>
</li>
<li>
<p>建议在部署模块之前，先通过mvn clean install将本地所有模块的改动都打入本地maven repo中去。</p>
</li>
<li>
<p>nacos本地启动命令：</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo sh ./startup.sh -m standalone
</code></pre></div></li>
</ul>
</li>
<li>
<p>seata本地启动命令：</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sh ./seata-server.sh
</code></pre></div></li>
<li>
<p>同时注意，seata的端口配置默认为7091，如果要更改默认启动端口，要在seata/conf/application.yml中打开如下配置：</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server:
  port: <span style="color:#ae81ff">8091</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-部署常见问题">4. 部署常见问题</h3>
<ul>
<li>
<p>镜像打包成功，但Mybatis相关类报错：ClassNotFound</p>
<ul>
<li>检查该模块启动类上是否有注解@EnableNativeHints，只有引入了该注解，才能让mybatis-plus在打包成本地镜像后正常工作。</li>
</ul>
</li>
<li>
<p>镜像打包成功，但Jwt相关类报错：DefaultJwtParser：ClassNotFound</p>
<ul>
<li>检查该模块对应打包配置目录下的proxy-config.json文件中有没有指定DefaultJwtParser，若没有指定则说明该类和其相关的模块均未被链接，需要使用对应模块的preCompile启动项启动该类，调用一次流程中使用了DefaultJwtParser的功能，再停止该模块，能够使proxy-config文件写入该类，再重新执行打包命令即可。</li>
</ul>
</li>
<li>
<p>执行native-image打包命令过程中报错：nosuchmethoderror</p>
<ul>
<li>如果是在一个之前能够正常工作的class中添加了新方法，那么需要让maven重新生成该类的安装包，执行mvn clean install即可。</li>
<li>如果是javabean中不存在getXXX或setXXX方法，检查是否使用lombok的@data、@AllArgsConstructor等注解，另外，不建议在项目中使用lombok。</li>
</ul>
</li>
<li>
<p>gateway无法转发请求到正确的子模块：</p>
<ul>
<li>检查gateway下的配置文件routes节点中是否已添加子模块的路由。</li>
<li>如果是新加的模块，由于AOT提前编译的局限性，需要在gateway目录下增加一个对应模块的OpenFeignClient，这样才能确保OpenFeign相关的配置类提前被链接。</li>
</ul>
</li>
<li>
<p>mybatis-plus使用lambda查询方式报错：</p>
</li>
<li>
<p>目前mybatis官方暂未出补丁修复AOT模式下lambda查询失效的问题，虽然github上issue已经存在，建议避开wrapper查询，自行在mapper中增加查询方法进行业务上的适配。</p>
</li>
<li>
<p>打包成native-image执行时，插入到mysql的中文字段乱码：</p>
<ul>
<li>show full columns from <schema>.<tablename>，确保数据库表字段的字符集是UTF8编码。</li>
<li>检查配置文件中jdbc-url配置，由于使用了hikariCP作为数据源，characterEncoding=uft8才能起到使用UTF8中文字符集的作用。</li>
</ul>
</li>
<li>
<p>native镜像RPC报错： java.lang.IllegalArgumentException: Object of class [org.springframework.context.support.GenericApplicationContext] must be an instance of interface org.springframework.context.annotation.AnnotationConfigRegistry] with root cause</p>
<ul>
<li>
<p>在对应的调用方模块配置文件中加入openfeign相关AOT配置，以qms-system调用user-system为例，需在qms-system模块的配置文件中加入如下内容：</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spring</span>:
  <span style="color:#f92672">cloud</span>:
    <span style="color:#f92672">refresh</span>:
      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">openfeign</span>:
      <span style="color:#75715e"># 支持AOT编译openfeign调用配置项 begin</span>
      <span style="color:#f92672">client</span>:
        <span style="color:#f92672">refresh-enabled</span>: <span style="color:#66d9ef">false</span>
        <span style="color:#f92672">config</span>:
          <span style="color:#f92672">user-system</span>:
            <span style="color:#f92672">urls</span>: <span style="color:#ae81ff">http://127.0.0.1:8880</span>
      <span style="color:#f92672">lazy-attributes-resolution</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">loadbalancer</span>:
      <span style="color:#f92672">ribbon</span>:
        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
      <span style="color:#f92672">nacos</span>:
        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">eager-load</span>:
        <span style="color:#f92672">clients</span>:
          - <span style="color:#ae81ff">user-system</span>
      <span style="color:#f92672">cache</span>:
        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#75715e"># 支持AOT编译openfeign调用配置项 end</span>
</code></pre></div></li>
<li>
<p>如果下游服务（上述例子user-system）为集群部署，由于AOT需要提前加载指定订阅服务的列表，所以user-system.urls中需要配置集群中所有节点的ip:port。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>全局错误处理失败，报错：No acceptable representation</p>
<ul>
<li>检查返回的result实现类是否有成员变量的get\set方法。</li>
</ul>
</li>
<li>
<p>集成seata之后，使用nacos作为配置中心，控制台报错，nacos-server端登录错误，完整错误如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">2023<span style="color:#f92672">-</span>12<span style="color:#f92672">-</span>09T13<span style="color:#f92672">:</span>14<span style="color:#f92672">:</span>38<span style="color:#f92672">.</span><span style="color:#a6e22e">423</span><span style="color:#f92672">+</span>08<span style="color:#f92672">:</span>00 ERROR 2971 <span style="color:#f92672">---</span> <span style="color:#f92672">[</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">client</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Worker</span><span style="color:#f92672">]</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">a</span><span style="color:#f92672">.</span><span style="color:#a6e22e">n</span><span style="color:#f92672">.</span><span style="color:#a6e22e">c</span><span style="color:#f92672">.</span><span style="color:#a6e22e">a</span><span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">.</span><span style="color:#a6e22e">process</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HttpLoginProcessor</span>   <span style="color:#f92672">:</span> login failed<span style="color:#f92672">:</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">:</span>500<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;message&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;caused: Cannot invoke \&#34;com.alibaba.nacos.plugin.auth.impl.jwt.NacosJwtParser.getExpireTimeInSeconds(String)\&#34; because \&#34;this.jwtParser\&#34; is null;&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;header&#34;</span><span style="color:#f92672">:{</span><span style="color:#e6db74">&#34;header&#34;</span><span style="color:#f92672">:{</span><span style="color:#e6db74">&#34;Accept-Charset&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Authorization&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Bearer&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Connection&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;close&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Content-Length&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;142&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;script-src &#39;self&#39;&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Date&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Sat, 09 Dec 2023 05:14:38 GMT&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Vary&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Access-Control-Request-Headers&#34;</span><span style="color:#f92672">},</span><span style="color:#e6db74">&#34;originalResponseHeader&#34;</span><span style="color:#f92672">:{</span><span style="color:#e6db74">&#34;Authorization&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;Bearer&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Connection&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;close&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Content-Length&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;142&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;script-src &#39;self&#39;&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Date&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;Sat, 09 Dec 2023 05:14:38 GMT&#34;</span><span style="color:#f92672">],</span><span style="color:#e6db74">&#34;Vary&#34;</span><span style="color:#f92672">:[</span><span style="color:#e6db74">&#34;Access-Control-Request-Headers&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Access-Control-Request-Method&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Origin&#34;</span><span style="color:#f92672">]},</span><span style="color:#e6db74">&#34;charset&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">}}</span>

</code></pre></div><ul>
<li>原因是nacos使用的2.2.3版本默认取消了登录验证，所以注释掉工程对应的配置文件中的username和password配置项，需要注意的是seata.config.nacos和seata.config.registry均需要注释用户名和密码。</li>
</ul>
</li>
<li>
<p>集成seata，使用nacos做配置中心，控制台报错：service.vgroupMapping.native-cloud-system-group配置为空：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">io<span style="color:#f92672">.</span><span style="color:#a6e22e">seata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">config</span><span style="color:#f92672">.</span><span style="color:#a6e22e">exception</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ConfigNotFoundException</span><span style="color:#f92672">:</span> service<span style="color:#f92672">.</span><span style="color:#a6e22e">vgroupMapping</span><span style="color:#f92672">.</span><span style="color:#a6e22e">native</span><span style="color:#f92672">-</span>cloud<span style="color:#f92672">-</span>system<span style="color:#f92672">-</span>group configuration item is required
</code></pre></div><ul>
<li>
<p>先检查工程模块下seata.config.nacos.group的值，发现配置项中定义去group为SEATA_GROUP的组中去获取配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">seata</span>:
  <span style="color:#f92672">tx-service-group</span>: <span style="color:#ae81ff">native-cloud-system-group</span>
  <span style="color:#f92672">service</span>:
    <span style="color:#f92672">tx-service-group</span>: <span style="color:#ae81ff">native-cloud-system-group</span>
    <span style="color:#f92672">vgroup-mapping</span>:
      <span style="color:#f92672">native-cloud-system-group</span>: <span style="color:#ae81ff">native</span>
  <span style="color:#f92672">config</span>:
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">nacos</span>
    <span style="color:#f92672">nacos</span>:
      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">8848</span>
      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">SEATA_GROUP</span>
</code></pre></div></li>
<li>
<p>再检查nacos dashboard中，namespace为public下(因为seata.config.nacos.namespace未配置，所以采用默认命名空间)是否添加了DataId为service.vgroupMapping.native-cloud-system-group且group为SEATA_GROUP的配置，如果没有，按照上述的条件添加一条配置，配置的值为：SEATA_GROUP。</p>
</li>
</ul>
</li>
<li>
<p>集成seata，集群订阅报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">[</span>timeoutChecker_1_1<span style="color:#f92672">]</span> ERROR i<span style="color:#f92672">.</span><span style="color:#a6e22e">s</span><span style="color:#f92672">.</span><span style="color:#a6e22e">c</span><span style="color:#f92672">.</span><span style="color:#a6e22e">r</span><span style="color:#f92672">.</span><span style="color:#a6e22e">n</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NettyClientChannelManager</span><span style="color:#f92672">:</span>188 <span style="color:#f92672">--&gt;</span> no available service found in cluster <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">default</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> please make sure registry config correct and keep your seata server running
</code></pre></div><ul>
<li>确认seata-server端配置文件中seata.registry.nacos.cluster的值，和客户端从nacos拉取的配置文件中dataID为<strong>service.vgroupMapping.native-cloud-system-group</strong>中的值相等。</li>
</ul>
</li>
<li>
<p>@GlobalTransactional，TCC模式只执行一阶段try的逻辑，不执行二阶段提交：</p>
<ul>
<li>
<p>断点打入GlobalTransactionalInterceptor中invoke方法，重点调试GlobalTransactional注解获取的过程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> GlobalTransactional globalTransactionalAnnotation <span style="color:#f92672">=</span> getAnnotation<span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> targetClass<span style="color:#f92672">,</span> GlobalTransactional<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</code></pre></div><p>查看method变量的方法名是否和业务代码中GlobalTransactional注解标记的方法名一致。</p>
</li>
</ul>
</li>
<li>
<p>集成seata，客户端启动后报错：RM can not reconnect server</p>
<ul>
<li>
<p>用下面的命令指定ip和端口重启seata-server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./seata-server.sh -h 127.0.0.1 -p <span style="color:#ae81ff">8091</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>集成seata后，分布式事务执行过程中报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">java<span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SQLSyntaxErrorException</span><span style="color:#f92672">:</span> Table <span style="color:#960050;background-color:#1e0010">&#39;</span>credit<span style="color:#f92672">.</span><span style="color:#a6e22e">undo_log</span><span style="color:#960050;background-color:#1e0010">&#39;</span> doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t exist
</code></pre></div><ul>
<li>
<p>发生在向数据库表进行insert记录的动作中，检查执行sql insert操作的方法是否已实现本地TccService，由于使用了seata代理了Datasource，不实现TccService情况下则会在插入时使用mysql默认的undolog表记录日志，而代理后的数据源无法获取mysql自带undolog，将执行insert语句的方法实现TccService即可，可参考下面委托表对应的TccService：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@LocalTCC</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">CreditEntrustTccService</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@TwoPhaseBusinessAction</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;generateCreditEntrust&#34;</span><span style="color:#f92672">,</span> commitMethod <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;generateCreditEntrustCommit&#34;</span><span style="color:#f92672">,</span> rollbackMethod <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;generateCreditEntrustRollback&#34;</span><span style="color:#f92672">)</span>
    Long <span style="color:#a6e22e">generateCreditEntrust</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@BusinessActionContextParameter</span><span style="color:#f92672">(</span>paramName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;creditEntrust&#34;</span><span style="color:#f92672">)</span> CreditEntrust creditEntrust<span style="color:#f92672">,</span>
                             <span style="color:#a6e22e">@BusinessActionContextParameter</span><span style="color:#f92672">(</span>paramName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;entrustProperty&#34;</span><span style="color:#f92672">)</span> EntrustProperty entrustProperty<span style="color:#f92672">);</span>

    Boolean <span style="color:#a6e22e">generateCreditEntrustCommit</span><span style="color:#f92672">(</span>BusinessActionContext businessActionContext<span style="color:#f92672">);</span>

    Boolean <span style="color:#a6e22e">generateCreditEntrustRollback</span><span style="color:#f92672">(</span>BusinessActionContext businessActionContext<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>OpenFeign报错feign.RetryableException: too many bytes written executing</p>
<ul>
<li>
<p>RPC传对象的时候造成请求体序列化后的字节数过多，需要取消openFeign拦截器中从前端请求带来的content-length限制，在项目下找到FeignBasicAuthRequestInterceptor并在遍历请求header循环中加入如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;content-length&#34;</span><span style="color:#f92672">)){</span>
  	<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>jdk17 使用annotation processor处理编译期注解，mvn install 注解处理器模块报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">服务配置文件不正确<span style="color:#f92672">,</span> 或构造处理程序对象javax<span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processing</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Processor</span><span style="color:#f92672">:</span> Provider com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ast</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LemonCompileProcessor</span> not found时抛出异常错误

</code></pre></div><ul>
<li>
<p>确保处理器模块maven的配置文件中加入如下配置项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">		<span style="color:#f92672">&lt;build&gt;</span>
        <span style="color:#f92672">&lt;plugins&gt;</span>
            <span style="color:#f92672">&lt;plugin&gt;</span>
                <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span>
                <span style="color:#f92672">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
                <span style="color:#f92672">&lt;configuration&gt;</span>
                  	<span style="color:#75715e">&lt;!-- 此项必须 --&gt;</span>
                    <span style="color:#f92672">&lt;proc&gt;</span>none<span style="color:#f92672">&lt;/proc&gt;</span>
                    <span style="color:#f92672">&lt;compilerArgs&gt;</span>
                      	<span style="color:#75715e">&lt;!-- 下面四项arg也建议加上，这样执行mvn compile命令会加上下面的参数，确保字节码增强所依赖的javac模块不会无法访问--&gt;</span>
                        <span style="color:#f92672">&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED<span style="color:#f92672">&lt;/arg&gt;</span>
                        <span style="color:#f92672">&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED<span style="color:#f92672">&lt;/arg&gt;</span>
                        <span style="color:#f92672">&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED<span style="color:#f92672">&lt;/arg&gt;</span>
                        <span style="color:#f92672">&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED<span style="color:#f92672">&lt;/arg&gt;</span>
                    <span style="color:#f92672">&lt;/compilerArgs&gt;</span>
                <span style="color:#f92672">&lt;/configuration&gt;</span>
            <span style="color:#f92672">&lt;/plugin&gt;</span>
        <span style="color:#f92672">&lt;/plugins&gt;</span>
    <span style="color:#f92672">&lt;/build&gt;</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>jdk17 使用annotation processor处理编译期注解，mvn install 注解处理器模块时代码构建不通过，报如下错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">api不可见</span>
com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processing不可见</span>
com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree不可见</span>
com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util不可见</span>
</code></pre></div><ul>
<li>
<p>由于jdk9 引入了jigsaw特性，原本javac所在的tools.jar被模块化，需要在idea设置中找到 Build,Execution,Deployment &ndash;&gt; Compiler &ndash;&gt; Java Complier &ndash;&gt; override complier parameters  per module，确保处理器模块export如下jdk自带模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">-</span>parameters
<span style="color:#f92672">--</span>add<span style="color:#f92672">-</span>exports<span style="color:#f92672">=</span>jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processing</span><span style="color:#f92672">=</span>ALL<span style="color:#f92672">-</span>UNNAMED
<span style="color:#f92672">--</span>add<span style="color:#f92672">-</span>exports<span style="color:#f92672">=</span>jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">api</span><span style="color:#f92672">=</span>ALL<span style="color:#f92672">-</span>UNNAMED
<span style="color:#f92672">--</span>add<span style="color:#f92672">-</span>exports<span style="color:#f92672">=</span>jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree</span><span style="color:#f92672">=</span>ALL<span style="color:#f92672">-</span>UNNAMED
<span style="color:#f92672">--</span>add<span style="color:#f92672">-</span>exports<span style="color:#f92672">=</span>jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">=</span>ALL<span style="color:#f92672">-</span>UNNAMED
</code></pre></div></li>
</ul>
</li>
<li>
<p>使用注解处理器的业务模块 执行mvn compile/install 报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">com</span><span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ast</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LemonCompileProcessor</span> <span style="color:#f92672">(</span>in unnamed module <span style="color:#a6e22e">@0x3ac3f6f</span><span style="color:#f92672">)</span> cannot access <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">com</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processing</span><span style="color:#f92672">.</span><span style="color:#a6e22e">JavacProcessingEnvironment</span> <span style="color:#f92672">(</span>in module jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">)</span> because module jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span> does not export com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processing</span> to unnamed module <span style="color:#a6e22e">@0x3ac3f6f</span>

</code></pre></div><ul>
<li>
<p>使用了idea自带的maven进行打包，所以不会读取配置在pom文件中的compilerArgs，需要手动为idea自带的maven指定解析时可访问的模块，打开settings &ndash;&gt;  Build,Execution,Deployment &ndash;&gt; build tools&ndash;&gt; maven &ndash;&gt; runner，设置maven运行时的vm option：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tex" data-lang="tex">--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED
</code></pre></div></li>
<li>
<p>同时，建议在业务模块pom文件中加上如下配置，使得命令行打包时能够读取配置项，使得编译期注解处理器能够正常被依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">		<span style="color:#f92672">&lt;build&gt;</span>
        <span style="color:#f92672">&lt;plugins&gt;</span>
            <span style="color:#f92672">&lt;plugin&gt;</span>
                <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span>
                <span style="color:#f92672">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
                <span style="color:#f92672">&lt;configuration&gt;</span>
                    <span style="color:#f92672">&lt;target&gt;</span>17<span style="color:#f92672">&lt;/target&gt;</span>
                    <span style="color:#f92672">&lt;source&gt;</span>17<span style="color:#f92672">&lt;/source&gt;</span>
                    <span style="color:#f92672">&lt;annotationProcessors&gt;</span>
                        <span style="color:#f92672">&lt;annotationProcessor&gt;</span>com.huang.ast.processor.LemonCompileProcessor<span style="color:#f92672">&lt;/annotationProcessor&gt;</span>
                    <span style="color:#f92672">&lt;/annotationProcessors&gt;</span>
                <span style="color:#f92672">&lt;/configuration&gt;</span>
            <span style="color:#f92672">&lt;/plugin&gt;</span>
        <span style="color:#f92672">&lt;/plugins&gt;</span>
    <span style="color:#f92672">&lt;/build&gt;</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>build modules或者执行mvn clean compile报如下错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AssertionError</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Assert</span><span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>155<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Assert</span><span style="color:#f92672">.</span><span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>46<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Bits</span><span style="color:#f92672">.</span><span style="color:#a6e22e">incl</span><span style="color:#f92672">(</span>Bits<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>186<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Flow$AssignAnalyzer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initParam</span><span style="color:#f92672">(</span>Flow<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>2232<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Flow$AssignAnalyzer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodDef</span><span style="color:#f92672">(</span>Flow<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>2156<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree</span><span style="color:#f92672">.</span><span style="color:#a6e22e">JCTree$JCMethodDecl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>JCTree<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>921<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TreeScanner</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>TreeScanner<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>49<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Flow$BaseAnalyzer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>Flow<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>444<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Flow$AssignAnalyzer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>Flow<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>1724<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Flow$AssignAnalyzer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">visitClassDef</span><span style="color:#f92672">(</span>Flow<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>2098<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree</span><span style="color:#f92672">.</span><span style="color:#a6e22e">JCTree$JCClassDecl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>JCTree<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>819<span style="color:#f92672">)</span>
	at jdk<span style="color:#f92672">.</span><span style="color:#a6e22e">compiler</span><span style="color:#f92672">/</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">sun</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">.</span><span style="color:#a6e22e">javac</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tree</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TreeScanner</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>TreeScanner<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>49<span style="color:#f92672">)</span>
</code></pre></div><ul>
<li>
<p>需要将treeMaker的节点指针定位至当前元素对应语法树的节点指针，在获取当前元素的语法树之后加入如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">JCTree jcTree <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">trees</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTree</span><span style="color:#f92672">(</span>element<span style="color:#f92672">);</span>
treeMaker<span style="color:#f92672">.</span><span style="color:#a6e22e">pos</span> <span style="color:#f92672">=</span> jcTree<span style="color:#f92672">.</span><span style="color:#a6e22e">pos</span><span style="color:#f92672">;</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>调用inner接口时报错：403 Forbidden</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">feign<span style="color:#f92672">.</span><span style="color:#a6e22e">FeignException$Forbidden</span><span style="color:#f92672">:</span> <span style="color:#f92672">[</span>403<span style="color:#f92672">]</span> during <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> to <span style="color:#f92672">[</span>http<span style="color:#f92672">:</span><span style="color:#75715e">//user-system/inner/user/getUserDetail/] [UserClient#getUserDetail(String)]: []
</span></code></pre></div><ul>
<li>
<p>原因是feign client发起RPC的时候，如果方法是在path后紧跟入参，比如/inner/user/getUserDetail/{userId}，需要入参和对应的innerController完全保持一致，检查InnerController被@PathVariable注解标记的方法入参，在对应的feign client中也存在@PathVariable：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">InnerController:
<span style="color:#a6e22e">@OpenApi</span>
<span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/getUserDetail/{userId}&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">getUserDetail</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> String userId<span style="color:#f92672">){</span>
  <span style="color:#66d9ef">return</span>  userDetailsService<span style="color:#f92672">.</span><span style="color:#a6e22e">loadUserByUsername</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

Feign Client<span style="color:#f92672">:</span>
<span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-system&#34;</span><span style="color:#f92672">,</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-system&#34;</span><span style="color:#f92672">,</span>contextId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;userSystem&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserClient</span> <span style="color:#f92672">{</span>

		<span style="color:#f92672">...</span> <span style="color:#75715e">// 其他方法
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/inner/user/getUserDetail/{userId}&#34;</span><span style="color:#f92672">)</span>
    T <span style="color:#a6e22e">getUserDetail</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> String userId<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>集成native-cloud-common-auth，通过@EnableSecurityAuthorization开启全局用户鉴权后，在进入controller方法之前，模块应该实现spring-security要求的userServiceImpl，否则请求该子系统任意接口（标记了openApi的白名单接口除外）都会返回403Forbidden错误，可参考交易模块已实现的UserServiceImpl：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * @description: 信用交易系统用户权限认证实现
</span><span style="color:#75715e"> * @author: huang.zh
</span><span style="color:#75715e"> * @create: 2024-09-15 08:09
</span><span style="color:#75715e"> **/</span>
<span style="color:#a6e22e">@Service</span>
<span style="color:#a6e22e">@Slf4j</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserDetailServiceImpl</span> <span style="color:#66d9ef">implements</span> UserDetailsService <span style="color:#f92672">{</span>


    <span style="color:#66d9ef">private</span> UserClient userClient<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserDetailServiceImpl</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Autowired</span> UserClient userClient<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">userClient</span> <span style="color:#f92672">=</span> userClient<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> UserDetails <span style="color:#a6e22e">loadUserByUsername</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> UsernameNotFoundException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 注意此时传入的username为jwtAuthUtil解析的userId
</span><span style="color:#75715e"></span>      	<span style="color:#75715e">// 发起RPC至账户子系统，请求用户的权限等运行时数据
</span><span style="color:#75715e"></span>        UserMetadata userMetadata <span style="color:#f92672">=</span> userClient<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserDetail</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
        String userId <span style="color:#f92672">=</span> userMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">();</span>
      	<span style="color:#75715e">// 当前系统需要鉴权，将UserMetadata转换为符合Spring-security权限校验体系的实体类User
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>SimpleGrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> userMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">getPermissions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>SimpleGrantedAuthority<span style="color:#f92672">::</span><span style="color:#66d9ef">new</span><span style="color:#f92672">).</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toList</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">(</span>userId<span style="color:#f92672">,</span>userId<span style="color:#f92672">,</span>authorities<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>
<p>注意，通过OpenFeign发起RPC请求，至账户子系统请求用户元数据，要求下游账户系统不能直接返回spring security的UserDetails接口及其任意一个实现类，是因为这些实现类没有默认无参构造函数，而OpenFeign解析response时使用jackson进行反序列化，要求响应类实体要有无参构造函数，这里可以使用native-cloud-common-auth模块下的UserMetadata，各上游系统获取到用户元数据后如果需要鉴权，可参考信用交易子系统将UserMetadata转换为符合Spring-security权限校验体系的实体类User：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * @description: 用户元数据运行时包装类，维护从账户系统获取的用户数据（userId，permissions...）
</span><span style="color:#75715e"> * @author: huang.zh
</span><span style="color:#75715e"> * @create: 2024-09-15 20:47
</span><span style="color:#75715e"> **/</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserMetadata</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> String userId<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> permissions<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserMetadata</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserMetadata</span><span style="color:#f92672">(</span>String userId<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> permissions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span> <span style="color:#f92672">=</span> userId<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">permissions</span> <span style="color:#f92672">=</span> permissions<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserId</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> userId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUserId</span><span style="color:#f92672">(</span>String userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span> <span style="color:#f92672">=</span> userId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getPermissions</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> permissions<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPermissions</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> permissions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">permissions</span> <span style="color:#f92672">=</span> permissions<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>单元测试中，将 类通过 @component 注解标记，尝试托管给 spring 容器，但单元测试方法报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">No qualifying bean of type <span style="color:#960050;background-color:#1e0010">&#39;</span>com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buffer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">GenerateMessageDataHandler</span><span style="color:#960050;background-color:#1e0010">&#39;</span> available
</code></pre></div><ul>
<li>
<p>这是因为测试类继承自 TestApplication，在 TestApplication 中 通过注解配置了指定单元测试时允许容器托管的类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@SpringBootTest</span><span style="color:#f92672">(</span>classes <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>TestApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> NettyStartListener<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> ServerProperty<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SocketServer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</code></pre></div><p>在 SpringBootTest注解 的 classes 属性中补齐单元测试中需要 Spring容器托管的类即可正常托管对应的 bean：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@SpringBootTest</span><span style="color:#f92672">(</span>classes <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>TestApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> NettyStartListener<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> ServerProperty<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SocketServer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> GenerateMessageDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> MessageMetaDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>使用SocketChannel 连接服务端进行测试，并发写入需要控制写入速率，通过 Thread.sleep(20l)可实现安全写入。</p>
</li>
<li>
<p>引入 ringbuffer 模块后，报错显示无法强制类型转换为指定的 springContext 容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Caused by<span style="color:#f92672">:</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCastException</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">boot</span><span style="color:#f92672">.</span><span style="color:#a6e22e">web</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AnnotationConfigServletWebServerApplicationContext</span> cannot be cast to <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AnnotationConfigApplicationContext</span> <span style="color:#f92672">(</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">boot</span><span style="color:#f92672">.</span><span style="color:#a6e22e">web</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AnnotationConfigServletWebServerApplicationContext</span> and org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AnnotationConfigApplicationContext</span> are in unnamed module of loader <span style="color:#960050;background-color:#1e0010">&#39;</span>app<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>
	at com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buffer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MessageMetaDataHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setApplicationContext</span><span style="color:#f92672">(</span>MessageMetaDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>classes<span style="color:#f92672">/:</span>na<span style="color:#f92672">]</span>
	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ApplicationContextAwareProcessor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invokeAwareInterfaces</span><span style="color:#f92672">(</span>ApplicationContextAwareProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>112<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>spring<span style="color:#f92672">-</span>context<span style="color:#f92672">-</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span><span style="color:#f92672">:</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">]</span>
	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ApplicationContextAwareProcessor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessBeforeInitialization</span><span style="color:#f92672">(</span>ApplicationContextAwareProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>87<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>spring<span style="color:#f92672">-</span>context<span style="color:#f92672">-</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span><span style="color:#f92672">:</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">]</span>
	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">factory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AbstractAutowireCapableBeanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applyBeanPostProcessorsBeforeInitialization</span><span style="color:#f92672">(</span>AbstractAutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>419<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>spring<span style="color:#f92672">-</span>beans<span style="color:#f92672">-</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span><span style="color:#f92672">:</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">]</span>
	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">factory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AbstractAutowireCapableBeanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initializeBean</span><span style="color:#f92672">(</span>AbstractAutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>1762<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>spring<span style="color:#f92672">-</span>beans<span style="color:#f92672">-</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span><span style="color:#f92672">:</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">]</span>
	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">springframework</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">factory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AbstractAutowireCapableBeanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doCreateBean</span><span style="color:#f92672">(</span>AbstractAutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>598<span style="color:#f92672">)</span> <span style="color:#f92672">~[</span>spring<span style="color:#f92672">-</span>beans<span style="color:#f92672">-</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span><span style="color:#f92672">:</span>6<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">]</span>
	<span style="color:#f92672">...</span> 15 common frames omitted
</code></pre></div><ul>
<li>
<p>这是因为业务子系统使用的AnnotationConfigServletWebServerApplicationContext进行托管，将 ringbuffer 中实现了 ApplicationContextAware 接口的 bean 所包含的成员变量全部改为对应的上层抽象接口ConfigurableApplicationContext即可进行强转，可参考：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Component</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageMetaDataHandler</span> <span style="color:#66d9ef">extends</span> ChannelInboundHandlerAdapter <span style="color:#66d9ef">implements</span> InitializingBean<span style="color:#f92672">,</span> ApplicationContextAware <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>MessageMetaDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String BUSINESS_FLAG_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;businessFlag&#34;</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> ConfigurableApplicationContext applicationContext<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Map<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span>BusinessHandler<span style="color:#f92672">&gt;</span> handlers<span style="color:#f92672">;</span>


    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelRead</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span> Object msg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 从容器中获取 BusinessHandler 接口的所有实现类
</span><span style="color:#75715e"></span>        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> BusinessHandler<span style="color:#f92672">&gt;</span> candidateBeans <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBeansOfType</span><span style="color:#f92672">(</span>BusinessHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        handlers <span style="color:#f92672">=</span> candidateBeans<span style="color:#f92672">.</span><span style="color:#a6e22e">values</span><span style="color:#f92672">().</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toMap</span><span style="color:#f92672">(</span>BusinessHandler<span style="color:#f92672">::</span>businessFlag<span style="color:#f92672">,</span> Function<span style="color:#f92672">.</span><span style="color:#a6e22e">identity</span><span style="color:#f92672">()));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setApplicationContext</span><span style="color:#f92672">(</span>ApplicationContext applicationContext<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationContext</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ConfigurableApplicationContext<span style="color:#f92672">)</span> applicationContext<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>如果业务子系统引入 Ringbuffer 模块后，无法找到 ringbuffer 模块下要求运行时托管给 Spring 容器管理的 bean，是因为默认 Spring 只扫描启动类所在目录下的所有 component、service、controller，需要手动通过注解引入 ringbuffer 模块下的 bean，可参考信用交易子系统启动类上的注解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * @description: 信用竞价交易子系统启动类
</span><span style="color:#75715e"> * @author: huang.zh
</span><span style="color:#75715e"> * @create: 2023-11-16 21:12
</span><span style="color:#75715e"> **/</span>
<span style="color:#a6e22e">@EnableApiDoc</span>
<span style="color:#a6e22e">@EnableSecurityAuthorization</span>
<span style="color:#a6e22e">@EnableGlobalExceptionHandler</span>
<span style="color:#a6e22e">@SpringBootApplication</span>
<span style="color:#a6e22e">@EnableNativeHints</span>
<span style="color:#a6e22e">@EnableDiscoveryClient</span>
<span style="color:#a6e22e">@EnableFeignClients</span>
<span style="color:#a6e22e">@MapperScan</span><span style="color:#f92672">(</span>basePackages <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;com.huang.credit.mapper&#34;</span><span style="color:#f92672">,</span>sqlSessionTemplateRef <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sqlSessionTemplate&#34;</span><span style="color:#f92672">)</span>
<span style="color:#75715e">// 引入 ringbuffer 模块下的 bean
</span><span style="color:#75715e"></span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>NettyStartListener<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> ServerProperty<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SocketServer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
        GenerateMessageDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> MessageMetaDataHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CreditTradeApplication</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>CreditTradeApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>也可以直接使用 ringbuffer 模块下的@EnableRingBuffer 注解，它会帮业务系统自动引入启用环形队列处理消息时所有需要托管的 bean：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * @description: 信用竞价交易子系统启动类
</span><span style="color:#75715e"> * @author: huang.zh
</span><span style="color:#75715e"> * @create: 2023-11-16 21:12
</span><span style="color:#75715e"> **/</span>
<span style="color:#a6e22e">@EnableApiDoc</span>
<span style="color:#a6e22e">@EnableSecurityAuthorization</span>
<span style="color:#a6e22e">@EnableGlobalExceptionHandler</span>
<span style="color:#a6e22e">@SpringBootApplication</span>
<span style="color:#a6e22e">@EnableNativeHints</span>
<span style="color:#a6e22e">@EnableDiscoveryClient</span>
<span style="color:#a6e22e">@EnableFeignClients</span>
<span style="color:#a6e22e">@MapperScan</span><span style="color:#f92672">(</span>basePackages <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;com.huang.credit.mapper&#34;</span><span style="color:#f92672">,</span>sqlSessionTemplateRef <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sqlSessionTemplate&#34;</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@EnableRingBuffer</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CreditTradeApplication</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>CreditTradeApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>如果在 gateway 模块下的 globalfilter 相关实现类中，直接通过 autowired 注入OpenFeign 的请求借口 FeignClient，会引起循环依赖报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Description:

The dependencies of some of the beans in the application context form a cycle<span style="color:#f92672">:</span>

<span style="color:#960050;background-color:#1e0010">┌─────┐</span>
<span style="color:#f92672">|</span>  partitionNoCheckFilter <span style="color:#f92672">(</span>field <span style="color:#66d9ef">private</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">UserSystemFeignClient</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PartitionNoCheckFilter</span><span style="color:#f92672">.</span><span style="color:#a6e22e">userSystemFeignClient</span><span style="color:#f92672">)</span>
<span style="color:#960050;background-color:#1e0010">↑</span>     <span style="color:#960050;background-color:#1e0010">↓</span>
<span style="color:#f92672">|</span>  com<span style="color:#f92672">.</span><span style="color:#a6e22e">huang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">UserSystemFeignClient</span>
<span style="color:#960050;background-color:#1e0010">↑</span>     <span style="color:#960050;background-color:#1e0010">↓</span>
<span style="color:#f92672">|</span>  corsGatewayFilterApplicationListener defined in <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">path</span> resource <span style="color:#f92672">[</span>org<span style="color:#f92672">/</span>springframework<span style="color:#f92672">/</span>cloud<span style="color:#f92672">/</span>gateway<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>GatewayAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>
<span style="color:#960050;background-color:#1e0010">↑</span>     <span style="color:#960050;background-color:#1e0010">↓</span>
<span style="color:#f92672">|</span>  routePredicateHandlerMapping defined in <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">path</span> resource <span style="color:#f92672">[</span>org<span style="color:#f92672">/</span>springframework<span style="color:#f92672">/</span>cloud<span style="color:#f92672">/</span>gateway<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>GatewayAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>
<span style="color:#960050;background-color:#1e0010">↑</span>     <span style="color:#960050;background-color:#1e0010">↓</span>
<span style="color:#f92672">|</span>  filteringWebHandler defined in <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">path</span> resource <span style="color:#f92672">[</span>org<span style="color:#f92672">/</span>springframework<span style="color:#f92672">/</span>cloud<span style="color:#f92672">/</span>gateway<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>GatewayAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>
<span style="color:#960050;background-color:#1e0010">└─────┘</span>

Action:

Relying upon circular references is discouraged and they are prohibited by <span style="color:#66d9ef">default</span><span style="color:#f92672">.</span> Update your application to remove the dependency cycle between beans<span style="color:#f92672">.</span> As a last resort<span style="color:#f92672">,</span> it may be possible to <span style="color:#66d9ef">break</span> the cycle automatically by setting spring<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allow</span><span style="color:#f92672">-</span>circular<span style="color:#f92672">-</span>references to <span style="color:#66d9ef">true</span><span style="color:#f92672">.</span>

</code></pre></div><ul>
<li>
<p>需要考虑引入 lazy 注解，在第一次实际使用该FeignClient 时才进行初始化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#a6e22e">@Lazy</span>
<span style="color:#a6e22e">@Autowired</span>
<span style="color:#66d9ef">private</span> UserSystemFeignClient userSystemFeignClient<span style="color:#f92672">;</span>

</code></pre></div></li>
<li>
<p>同时，需要注意 Spring Cloud Gateway中，不支持动态路由，需要将配置项中对应 serviceId 的 url 改成具体地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#f92672">openfeign</span>:
  <span style="color:#f92672">client</span>:
    <span style="color:#f92672">refresh-enabled</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">config</span>:
      <span style="color:#f92672">user-system</span>:
        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://127.0.0.1:8880</span>
      <span style="color:#f92672">quota-manager-system</span>:
        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://127.0.0.1:8881</span>
      <span style="color:#f92672">credit-trade-system</span>:
        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://127.0.0.1:8883</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="5开发日志">5.开发日志</h3>
<table>
<thead>
<tr>
<th style="text-align:center">日期</th>
<th style="text-align:center">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2023.07.08</td>
<td style="text-align:center">项目基本依赖引入，完成框架搭建。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.15</td>
<td style="text-align:center">账户系统完成基础功能：账户查询、营业部树查询。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.18</td>
<td style="text-align:center">账户系统权限系统表结构建立完成，基于RBAC模型。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.20</td>
<td style="text-align:center">账户系统权限体系编码完成，自测完成，实现用户粒度角色权限筛选与聚合。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.24</td>
<td style="text-align:center">jwt+security依赖引入，登录+鉴权系统组合完成，实现登录赋权和api粒度权限校验。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.25</td>
<td style="text-align:center">部分查询调整为mybatis-plus提供的lambda查询模式，减少代码中sql出现的频次。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.26</td>
<td style="text-align:center">引入nacos，账户子系统具备服务注册功能，同时引入open-feign，提供基于http协议的RPC。</td>
</tr>
<tr>
<td style="text-align:center">2023.07.31</td>
<td style="text-align:center">native-image引入，改造部分类的加载方式，兼容native镜像打包。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.03</td>
<td style="text-align:center">Graal-sdk依赖升级为22.3.2，解决native-image在AOT阶段的报错问题。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.09</td>
<td style="text-align:center">添加账户子系统AOT脚本，确保所有模块能够在编译时期准确链接。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.10</td>
<td style="text-align:center">新增common模块，用于放置公共配置类和工具类。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.12</td>
<td style="text-align:center">抽取账户配置引导类（security、mybatis-plus、swagger-api&hellip;）至common模块下，启动、打包成功。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.15</td>
<td style="text-align:center">新增common-api模块，移动公用entity至该模块路径，供后续子系统间基于公用entity传输数据。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.18</td>
<td style="text-align:center">新增额度子系统，完成框架搭建和数据流通、子系统间通信测试。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.23</td>
<td style="text-align:center">额度子系统完成头寸体系建设，提供头寸划转资金、证券功能，编码完成，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.29</td>
<td style="text-align:center">新增自定义注解openApi，配合鉴权体系实现白名单配置机制。</td>
</tr>
<tr>
<td style="text-align:center">2023.08.31</td>
<td style="text-align:center">子系统全部增加domain域，所有服务不再直接访问dao层查询，统一由domain域提供数据访问和操作的途径。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.10</td>
<td style="text-align:center">新增gateway模块，实现统一网关分发路由。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.16</td>
<td style="text-align:center">调整open-feign相关AOT配置，解决gateway和open-feign兼容问题导致的native程序请求分发失败。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.20</td>
<td style="text-align:center">gateway模块增加open-feign子系统代理类，能够使代理类被正确链接，解决AOT报错。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.24</td>
<td style="text-align:center">新增common-util模块，放置常量类和工具类。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.29</td>
<td style="text-align:center">新增common-result模块，提供子系统对外统一结果封装。</td>
</tr>
<tr>
<td style="text-align:center">2023.09.31</td>
<td style="text-align:center">异常体系建设完成，可自定义异常种类、异常处理类，具备统一捕捉业务异常的能力。</td>
</tr>
<tr>
<td style="text-align:center">2023.10.07</td>
<td style="text-align:center">业务检查模板体系设计完成、编码完成，提供高度抽象的模板检查策略，易于扩展。</td>
</tr>
<tr>
<td style="text-align:center">2023.10.15</td>
<td style="text-align:center">账户子系统、额度子系统业务完成业务检查模板改造，各类业务适配业务模板，编码完成、自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2023.10.20</td>
<td style="text-align:center">提供接口api文档配置化注解，实现可插拔。</td>
</tr>
<tr>
<td style="text-align:center">2023.10.26</td>
<td style="text-align:center">新增大量枚举，优化业务检查代码，使用枚举代替所有魔法值。</td>
</tr>
<tr>
<td style="text-align:center">2023.10.30</td>
<td style="text-align:center">新建信用交易子系统，完成框架搭建。</td>
</tr>
<tr>
<td style="text-align:center">2023.11.03</td>
<td style="text-align:center">交易时间体系建设完成，具备不同业务交易时间检查能力。</td>
</tr>
<tr>
<td style="text-align:center">2023.11.11</td>
<td style="text-align:center">融资买入参数检查编码完成、自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2023.11.13</td>
<td style="text-align:center">竞价业务证券代码检查体系建设完成，统一提供基础证券检查功能，并允许子类自行扩展。</td>
</tr>
<tr>
<td style="text-align:center">2023.11.23</td>
<td style="text-align:center">融资买入委托数据检查编码完成，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.02.26</td>
<td style="text-align:center">完成RPC调用融资日间实时合约生成逻辑，并基于TCC实现分布式事务补偿机制，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.02.27</td>
<td style="text-align:center">取消信用委托表order_id索引唯一属性，使分布式事务补偿后出现同一订单流水号能够存在多条废单委托，且仅存在一条有效委托，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.02.29</td>
<td style="text-align:center">补全合约系统日间实时合约流水和合约汇总流水记录逻辑，结合融资买入业务自测通过。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.01</td>
<td style="text-align:center">引入javac-annotation processor编译期注解处理器，并解决JDK17模块化引起的maven compile以及idea build module报错，编译期处理器组件框架搭建完成，待实现具体注解处理器。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.02</td>
<td style="text-align:center">调整日间合约汇总表索引，增加init_date字段并取消流水表索引unique属性，分布式事务代码配套修改。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.03</td>
<td style="text-align:center">编译期注解框架完成get和set方法生成，值拷贝语句生成编码进度50%。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.04</td>
<td style="text-align:center">值拷贝语句编码完成，自测通过，待结合业务逻辑进行测试。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.06</td>
<td style="text-align:center">搭建环形队列模块，引入ringbuffer，并结合netty实现高性能收取报文处理数据。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.07</td>
<td style="text-align:center">自定义简要二进制通信协议，编码50%。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.08</td>
<td style="text-align:center">自定义简要二进制通信协议，编码完成，待业务核心模块引入该组件测试报文接收效果。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.10</td>
<td style="text-align:center">ringbuffer模块，netty接收二进制数据根据报文规则解析字节代码修改，测试完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.03.12</td>
<td style="text-align:center">ringbuffer模块引入disruptor，编写通用api，自测完成，压测结果支持16400 QPS。</td>
</tr>
<tr>
<td style="text-align:center">2024.08.30-2024.08.31</td>
<td style="text-align:center">设计信用交易后台费用表结构，完成费用预算业务组件编写，自测完成，待业务模块引入使用。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.03</td>
<td style="text-align:center">委托表扩充费用和金额字段，在委托过程中增加费用和发生金额赋值，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.04</td>
<td style="text-align:center">资产账号表扩充费用属性串字段，增加交易公用费用属性获取工具，拟在委托过程中获取费用属性以计算费用，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.05</td>
<td style="text-align:center">证券交易费用模块结合融资买入业务自测后修复bug，完成业务流程中费用预算的开发。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.06</td>
<td style="text-align:center">费用预算引入低费用标志，当标志开启时，委托发生费用小于最低费用时不收取最低佣金，结合账户系统费用串自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.09</td>
<td style="text-align:center">新建专项业务头寸账户表和专项业务资金表，支持融资买入检查客户专项头寸账户和专项头寸可用资金，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.10</td>
<td style="text-align:center">支持融资买入更新专项头寸可用资金，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.11</td>
<td style="text-align:center">普通业务头寸资金流水表扩充发生标志和交易日期字段，并在融资买入委托支持更新，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.12</td>
<td style="text-align:center">自测过程中发现专项头寸更新未实现TccService，需要实现TccService以便支持分布式事务。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.13</td>
<td style="text-align:center">实现专项头寸分布式事务TccService，代替原有的专项头寸domain进行头寸资金更新，头寸资金更新模块自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.15</td>
<td style="text-align:center">信用交易系统接入全局账户鉴权功能，结合融资买入业务自测完成，完成Api粒度鉴权</td>
</tr>
<tr>
<td style="text-align:center">2024.09.16</td>
<td style="text-align:center">梳理模块总览，编写各模块职责。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.18</td>
<td style="text-align:center">新增缓存管理类，用于缓存运行时RPC获取的用户元数据信息，减少RPC至账户系统的开销，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.19</td>
<td style="text-align:center">1、修复用户元数据缓存未能命中的bug，自测完成。<br/>2、缓存支持可重入锁，以应对并发更新。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.20</td>
<td style="text-align:center">信用交易核心获取序列号使用缓存双写模式，自测完成</td>
</tr>
<tr>
<td style="text-align:center">2024.09.21</td>
<td style="text-align:center">1、额度流水计数器分片表扩充step步长字段，支持交易核心批量申请序列号，编码完成，自测完成。<br/>2、专项业务头寸资金流水表的计数器类型和普通业务头寸资金流水表计数器独立，防止数据库行锁资源频繁竞争，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.23</td>
<td style="text-align:center">修复bug，当前缓存号段无序列号可用时，更新该号段数据库表中可用状态为不可用。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.24</td>
<td style="text-align:center">流水计数器分布式事务实现类支持缓存号段数据上下场的能力，避免发生故障停机后无法恢复缓存数据，造成号段资源浪费。自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.26</td>
<td style="text-align:center">流水计数器获取类改造，可缓存多种计数器种类的号段数据，并具备计数器号段数据上场能力，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.27</td>
<td style="text-align:center">流水计数器获取类改造，使同一种计数器号段能够连续申请，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.28</td>
<td style="text-align:center">信用交易专项头寸资金流水表，生成序列号改造：使用带缓存功能的统一流水计数器工具类，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.09.30</td>
<td style="text-align:center">统一流水计数器缓存扩展申请号段标志，只在申请号段时才更新当前计数器种类的号段起始值缓存，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.01</td>
<td style="text-align:center">构造回报报文，并解析成功，成功反序列化成MessageMetaData，供业务流程使用，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.02</td>
<td style="text-align:center">编写生成字节报文工具，ByteTypeUtil.<em>generateBytes</em>，支持根据传入任意 map 生成字节报文，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.03</td>
<td style="text-align:center">LemonBufferTest 单元测试， 65535 个线程同时通过ByteTypeUtil.<em>generateBytes</em>生成字节报文并打入队列，总消耗时间 814ms，性能 ok。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.05</td>
<td style="text-align:center">LemonBuffer 模块新增消息处理器，并将模块下的处理器全部托管给 spring 容器，过滤不包含businessFlag 的消息，自测完成。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.08</td>
<td style="text-align:center">LemonBuffer 模块扩展 BusinessHandler，作为所有业务消息处理子类的抽象，并托管给 Spring 容器处理。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.09</td>
<td style="text-align:center">1、消息处理器MessageMetaDataHandler 具备发现 businessHandler 的能力，并能够根据消息中业务标志采用具体的消息业务处理器处理消息。<br/>2、完善单元测试类，各业务子系统可参考SocketServerTest 和 TestBusinessHandler 实现对应的消息处理器。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.10</td>
<td style="text-align:center">考虑如何实现消息处理类绑定 LemonBuffer 实现异步处理消息。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.11</td>
<td style="text-align:center">信用交易子系统引入 ringbuffer 模块，解决报错，成功运行。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.12</td>
<td style="text-align:center">新增注解@EnableRingBuffer，供业务系统使用，集成环形队列模块时通过该注解引入所有需要托管给 Spring 容器的 bean。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.14</td>
<td style="text-align:center">构建回报异常体系，Ringbuffer 执行回报报错时统一捕获异常。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.15</td>
<td style="text-align:center">融资买入回报模块流程功能编码，完成委托状态计算。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.18</td>
<td style="text-align:center">1、合约表扩展合约成交数量字段，委托回报时更新该字段。<br/>2、回报流程中新增更新合约方法，支持更新合约成交数量和融资买入在途委托金额。<br/>3、支持回报更新合约汇总，并记录合约汇总流水。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.19</td>
<td style="text-align:center">1、回报扩充 isCancelOrder 字段，用于判断撤单委托和原委托，对应处理不同的流程。<br/>2、BusinessHandler 接口扩展 doRevert 方法，各实现类实现后，用于正常回报流程处理出错时触发回滚操作。<br/>3、融资买入回报处理器支持废单处理流程。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.22</td>
<td style="text-align:center">新增撤单委托接口，同时新增撤单委托专用的业务检查 specification，用于撤单时间检查、原委托状态校验。 <br/>2、新增撤单委托专用时间检查处理器。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.24</td>
<td style="text-align:center">1、融资买入成交回报测试完成，修复 bug。<br/>2、废单场景回报修正合约汇总表在途金额更新错误。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.25</td>
<td style="text-align:center">1、信用交易委托表扩展原委托字段，用于撤单委托时记录原委托编号，定位原委托信息。<br/>2、完成撤单委托时原委托状态检查。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.26</td>
<td style="text-align:center">撤单委托完成编码，支持内部撤单和外部撤单，并支持内部撤单直接作废融资合约，待自测。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.28</td>
<td style="text-align:center">1、修复内部撤单合约汇总在途金额更新不正确的问题。<br/>2、新增CreditEntrustBackWriteHandler，并集成 lemonBuffer，用于异步处理交易所回写请求。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.29</td>
<td style="text-align:center">1、支持撤单成交委托状态计算，支持原委托部分成交后撤单和整笔全部撤单。<br/>2、修复撤单委托下单后，因为委托类型不正确而引起的撤单成交回报时委托状态不能正确计算的问题。<br/>3、内部撤单支持回冲头寸资金和前后台费用。<br/>4、撤单成交回报支持回冲头寸资金（包括原委托部分成交后在途金额+后台的回冲）。<br/>5、撤单成交回报支持根据本次回报成交的金额计算后台费用，并累加至清算金额 clearBalance。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.30</td>
<td style="text-align:center">1、支持撤单委托废单回报处理。<br/>2、原委托在撤单委托废单回报时修正为撤单前的状态。<br/>3、修正融资买入委托成交回报时费用计算不准确，支持委托全部成交的情况时，清算金额计算考虑前台费用。</td>
</tr>
<tr>
<td style="text-align:center">2024.10.31</td>
<td style="text-align:center">1、修复融资买入委托成交回报时，未正确计算合约汇总表成交数量的问题。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.01</td>
<td style="text-align:center">新增信用客户持仓表，并支持更新或新增一条指定代码的持仓记录。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.02</td>
<td style="text-align:center">1、新增信用客户持仓流水表，支持在更新信用客户持仓流水的同时记录流水。<br/>2、全局流水序列号获取类 SerialCounterNoTccService，支持不开启分布式事务时使用，走常规RPC 获取最新序列号。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.04</td>
<td style="text-align:center">1、修复融资买入内部撤单时，回冲头寸多扣减费用的问题。<br/>2、融资买入成交回报处理，支持在更新委托状态前更新持仓数据。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.05</td>
<td style="text-align:center">1、修复回写时往队列发布回写消息，对应的 handler 不处理的问题。<br/>2、新增内部回写测试接口，供内部处理回写请求的转换。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.06</td>
<td style="text-align:center">1、新增内部回报测试接口，供内部处理回报请求的转换。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.07</td>
<td style="text-align:center">1、支持系统初始化校验，交易日期非当日的情况直接报错返回。<br/>2、新增卖券还款业务检查责任链。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.19</td>
<td style="text-align:center">1、修复融资买入成交回报持仓更新不准确的bug。<br/>2、卖券还款业务检查编码进度 20%。</td>
</tr>
<tr>
<td style="text-align:center">2024.11.20</td>
<td style="text-align:center">时间检查方法抽象至公共类 TradeDateTimeCheckHandler，方便各业务检查处理类复用。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.03</td>
<td style="text-align:center">资产账号表新增 partition_no 字段，用于后续多分片水平扩展。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.04</td>
<td style="text-align:center">gateway 配置文件中的静态路由维护多分片模式配置。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.05</td>
<td style="text-align:center">使用 discovery 注册分片号，在 gateway 获取serviceId 对应的分片号。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.07</td>
<td style="text-align:center">新增 dynamic-routes模块，具备动态路由缓存，运行时注入容器上下文。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.08</td>
<td style="text-align:center">1、新增 updateDynamicRoutes方法，用于 DynamicRoutesCache 运行时更新动态路由缓存。<br/>2、新增PartitionNoCheckFilter，运行时可根据请求找到对应的分片，并转发至对应的分片核心。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.09</td>
<td style="text-align:center">PartitionNoCheckFilter逻辑优化，支持根据路由配置中的多分片开启模式开关，来动态获取路由。若多分片模式未开启，则直接放行。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.10</td>
<td style="text-align:center">PartitionNoCheckFilter逻辑优化，如果请求头不带有分片号，则从表单域中获取 fundAccount，如果获取不到则报错返回。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.12</td>
<td style="text-align:center">1、解决PartitionNoCheckFilter中，注入 FeignClient 导致循环引用报错的问题。<br/>2、账户系统支持与网关交互，向网关提供分片号和账号区间的关联信息。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.13</td>
<td style="text-align:center">PartitionNoCheckFilter支持通过定时触发异步线程的模式请求分片和账号的关联信息。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.14</td>
<td style="text-align:center">1、PartitionNoCheckFilter支持通过新增 partitionNoCache 维护资产账号和分片的信息。<br/>2、DynamicRoutesCache要求传入拼接好的 cacheKey 作为命中缓存的入参。<br/>3、PartitionNoCheckFilter增加多分片模式元数据异常拦截报错的逻辑，多分片模式下没有 serviceId 以及 通过账户未落在缓存中的分片账号区间段内，均报错返回。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.15</td>
<td style="text-align:center">DynamicRoutesCache 引入 Nacos NamingService，成功解析网关配置文件中配置的spring.cloud.gateway.routes配置项，后续将通过在初始化阶段注册配置文件中配置的所有 serviceId 的状态监听器</td>
</tr>
<tr>
<td style="text-align:center">2025.03.17</td>
<td style="text-align:center">DynamicRoutesCache 改用 NotifyCenter 的抽象类 Subscriber 监听服务分片的状态，后续需要为每一个配置了多分片模式的serviceId 实现对应的Subscriber，做到松耦合。</td>
</tr>
<tr>
<td style="text-align:center">2025.03.18</td>
<td style="text-align:center">DynamicRoutesCache 成功订阅多分片服务信息，具备根据 serviceId#paritionNo的模式维护分片的URI信息。</td>
</tr>
</tbody>
</table>
<h3 id="6初始化脚本">6.初始化脚本</h3>
<p>系统初始化脚本，打入后，交易回到最初数据状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> compact.compact;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> compact.compact_jour;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> compact.compact_summary;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> compact.compact_summary_jour;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> credit.credit_entrust;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> credit.credit_trade_time;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> credit.credit_serial_counter_record;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> credit.credit_stock_real_jour;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> credit.special_cash_group_fund_jour;

<span style="color:#66d9ef">truncate</span> <span style="color:#66d9ef">table</span> quota.cash_group_fund_jour;

<span style="color:#75715e">-- 初始化普通业务头寸资金表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.cash_group_fund <span style="color:#66d9ef">set</span> financing_total_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000000</span>.<span style="color:#ae81ff">00</span>,enable_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000000</span>.<span style="color:#ae81ff">00</span>,frozen_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span>,financing_used_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> <span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;

<span style="color:#75715e">-- 初始化专项业务头寸资金表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> credit.special_cash_group_fund <span style="color:#66d9ef">set</span> fin_total_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000000</span>.<span style="color:#ae81ff">00</span>,enable_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000000</span>.<span style="color:#ae81ff">00</span>,fin_used_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>,ref_due_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>,frozen_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>,cash_interest <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;

<span style="color:#75715e">-- 重置流水号额度表各业务种类的计数器为初始值
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> serial_counter_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span> <span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ;

<span style="color:#75715e">-- 重置普通头寸业务资金流水表的计数器号段长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">where</span> serial_counter_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#75715e">-- 重置信用交易委托表的计数器号段长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#66d9ef">where</span> serial_counter_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

<span style="color:#75715e">-- 重置专项头寸业务资金流水表的计数器号段长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#66d9ef">where</span> serial_counter_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;

<span style="color:#75715e">-- 重置专项头寸业务资金流水表回滚的计数器号段长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">where</span> serial_counter_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;

<span style="color:#75715e">-- 重置信用客户持仓流水表的计数器号段长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">update</span> quota.serial_no_counter <span style="color:#66d9ef">set</span> step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">where</span> serial_counter_no <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;


<span style="color:#75715e">-- 插入信用交易时间表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> credit.credit_trade_time (id, time_kind, init_date, begin_time, end_time, remark, withdraw_flag) <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;0-交易系统是否初始化&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>);
<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> credit.credit_trade_time (id, time_kind, init_date, begin_time, end_time, remark, withdraw_flag) <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;3&#39;</span>, <span style="color:#ae81ff">20231130</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">99999999</span>, <span style="color:#e6db74">&#39;信用交易时间&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>);
<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> credit.credit_trade_time (id, time_kind, init_date, begin_time, end_time, remark, withdraw_flag) <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#39;4&#39;</span>, <span style="color:#ae81ff">20241028</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">99999999</span>, <span style="color:#e6db74">&#39;信用委托撤单时间&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>);

</code></pre></div><p>存储过程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#75715e">-- 检查资产账号表是否存在分片号的存储过程
</span><span style="color:#75715e">-- 信用交易账号，默认 52 分片
</span><span style="color:#75715e"></span><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">procedure</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> checkPartitionNo;
<span style="color:#66d9ef">delimiter</span> <span style="color:#f92672">//</span>
<span style="color:#66d9ef">create</span> <span style="color:#66d9ef">procedure</span> checkPartitionNo()
<span style="color:#66d9ef">begin</span>
  <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>row_num <span style="color:#66d9ef">from</span> information_schema.COLUMNS
         <span style="color:#66d9ef">where</span> TABLE_SCHEMA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user&#39;</span>
           <span style="color:#66d9ef">and</span> <span style="color:#66d9ef">TABLE_NAME</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;fund_account&#39;</span> <span style="color:#66d9ef">and</span> <span style="color:#66d9ef">COLUMN_NAME</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;partition_no&#39;</span>;
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">@</span>row_num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">user</span>.fund_account <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> partition_no int <span style="color:#66d9ef">default</span> <span style="color:#ae81ff">52</span> <span style="color:#66d9ef">comment</span> <span style="color:#e6db74">&#39;分片号&#39;</span>;

<span style="color:#66d9ef">end</span> <span style="color:#66d9ef">if</span>;
<span style="color:#66d9ef">end</span>; <span style="color:#f92672">//</span>
<span style="color:#66d9ef">delimiter</span> ;
<span style="color:#66d9ef">call</span> checkPartitionNo();


</code></pre></div><h3 id="7字段释义">7.字段释义</h3>
<table>
<thead>
<tr>
<th>字段名</th>
<th>mysql类型</th>
<th>java类型</th>
<th>备注</th>
<th>枚举</th>
</tr>
</thead>
<tbody>
<tr>
<td>userId</td>
<td>varchar(64)</td>
<td>String</td>
<td>用户id（客户层id）</td>
<td>不涉及</td>
</tr>
<tr>
<td>fundAccount</td>
<td>bigint</td>
<td>long</td>
<td>资产账号</td>
<td>不涉及</td>
</tr>
<tr>
<td>stockAccount</td>
<td>varchar(64)</td>
<td>String</td>
<td>股东账号</td>
<td>不涉及</td>
</tr>
<tr>
<td>cashGroupAccount</td>
<td>bigint</td>
<td>Long</td>
<td>头寸账号</td>
<td>不涉及</td>
</tr>
<tr>
<td>branchNo</td>
<td>int</td>
<td>int</td>
<td>营业部编号</td>
<td>不涉及</td>
</tr>
<tr>
<td>accountStatus</td>
<td>int</td>
<td>int</td>
<td>账号状态</td>
<td>不涉及</td>
</tr>
<tr>
<td>realAction</td>
<td>tinyint</td>
<td>int</td>
<td>发生动作，常用在记录资金流水、股份流水时，表明是成交回报流程或是委托流程发生的资金、股份变更</td>
<td>0，委托过程中记录流水<br/>1，回报过程中记录流水</td>
</tr>
<tr>
<td>entrustStatus</td>
<td>tinyint</td>
<td>int</td>
<td>委托状态，表明一笔委托当前在业务系统中的流转状态</td>
<td>0：未报<br/>1：待报<br/>2：已报<br/>6：已撤<br/>8：已成</td>
</tr>
<tr>
<td>compactStatus</td>
<td>char(1)</td>
<td>char</td>
<td>合约状态，表明信用交易产生合约的当前状态</td>
<td>0：未了结<br/>1：部分了结<br/>2：已了结<br/>3：作废</td>
</tr>
<tr>
<td>compactType</td>
<td>char(1)</td>
<td>char</td>
<td>合约类型，融资或者融券合约</td>
<td>1：融资合约<br/>2：融券合约</td>
</tr>
<tr>
<td>exchangeType</td>
<td>varchar(10)</td>
<td>String</td>
<td>交易市场</td>
<td>1：上海市场<br/>2：深圳市场<br/>3：北交所</td>
</tr>
<tr>
<td>fareProp</td>
<td>char(1)</td>
<td>String</td>
<td>费用属性，只有前台/后台费用</td>
<td>0：前台费用<br/>1：后台费用</td>
</tr>
<tr>
<td>fareType</td>
<td>char(1)</td>
<td>String</td>
<td>费用类型</td>
<td>0-佣金<br/>1-印花税<br/>2-过户费<br/>3-其他费用<br/>x-其他费用</td>
</tr>
<tr>
<td>fundAccountStatus</td>
<td>int</td>
<td>int</td>
<td>资产账号状态</td>
<td>0：正常<br/>1：休眠<br/>2：冻结<br/>4：销户<br/>5：未知</td>
</tr>
<tr>
<td>seatProp</td>
<td>smallInt</td>
<td>int</td>
<td>席位属性</td>
<td>0：普通席位<br/>7：信用席位</td>
</tr>
<tr>
<td>stockAccountStatus</td>
<td>smallint</td>
<td>int</td>
<td>证券账号状态</td>
<td>0：正常<br/>1：休眠<br/>2：未知<br/></td>
</tr>
<tr>
<td>accountType</td>
<td>char</td>
<td>char</td>
<td>证券账号类型</td>
<td>0：普通证券账号<br/>1：信用证券账号</td>
</tr>
<tr>
<td>stockType</td>
<td>char(2)</td>
<td>String</td>
<td>证券类型</td>
<td>0：股票<br/>4：新股<br/>G：新债</td>
</tr>
<tr>
<td>entrustPrice</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>委托价格</td>
<td>不涉及</td>
</tr>
<tr>
<td>entrustAmount</td>
<td>int</td>
<td>int</td>
<td>委托数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>entrustBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>委托总金额，不包含前后台费用</td>
<td>不涉及</td>
</tr>
<tr>
<td>prevBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>委托发生金额，委托下单时落表，包含前后台费用</td>
<td>不涉及</td>
</tr>
<tr>
<td>clearBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>清算金额，回报时更新，包含当前成交数量对应的前后台费用（分笔成交回报的场景，每次回报会重新计算本次回报金额对应的后台费用，并累加至清算金额。）</td>
<td>不涉及</td>
</tr>
<tr>
<td>orderId</td>
<td>bigint</td>
<td>Long</td>
<td>委托编号</td>
<td>不涉及</td>
</tr>
<tr>
<td>origOrderId</td>
<td>bigint</td>
<td>Long</td>
<td>原委托编号，撤单委托记录要撤单的委托号，普通委托记录自身的委托号</td>
<td>不涉及</td>
</tr>
<tr>
<td>businessAmount</td>
<td>int</td>
<td>int</td>
<td>成交数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>businessPrice</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>成交价格</td>
<td>不涉及</td>
</tr>
<tr>
<td>businessBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>成交金额，不包含前后台费用</td>
<td>不涉及</td>
</tr>
<tr>
<td>stockCode</td>
<td>varchar(10)</td>
<td>String</td>
<td>证券代码</td>
<td>不涉及</td>
</tr>
<tr>
<td>realBuyAmount</td>
<td>bigint</td>
<td>Long</td>
<td>回报买入数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>realBuyBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>回报买入金额</td>
<td>不涉及</td>
</tr>
<tr>
<td>realSellAmount</td>
<td>bigint</td>
<td>Long</td>
<td>回报卖出数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>realSellBalance</td>
<td>decimal(20,2)</td>
<td>BigDecimal</td>
<td>回报卖出金额</td>
<td>不涉及</td>
</tr>
<tr>
<td>frozenAmount</td>
<td>bigint</td>
<td>Long</td>
<td>当日买入冻结数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>unfrozenAmount</td>
<td>bigint</td>
<td>Long</td>
<td>当日卖出解冻数量</td>
<td>不涉及</td>
</tr>
<tr>
<td>currentAmount</td>
<td>bigint</td>
<td>Long</td>
<td>当前数量（包含不可卖的证券数量）</td>
<td>不涉及</td>
</tr>
<tr>
<td>enableAmount</td>
<td>bigint</td>
<td>Long</td>
<td>可用数量（可进行卖出操作的证券数量）</td>
<td>不涉及</td>
</tr>
</tbody>
</table>
<h3 id="8-todo-list">8. todo list</h3>
<ul>
<li>✅<s>流水计数器中的缓存功能，需要维护每一种计数器种类的号段起始值，否则存在多种计数器种类缓存无法击中的风险。</s></li>
<li>✅<s>专项头寸资金发生变化，流水序列号使用带缓存的统一流水计数器工具类。</s></li>
<li>✅<s>流水计数器缓存，需要判断新申请号段的情况下才更新缓存中号段的起始值。</s></li>
<li>✅<s>构造成交回报报文，并解析报文。</s></li>
<li>✅<s>统一报文反序列化处理器和消息元数据处理器托管给 Spring 容器管理生命周期，支持嵌入各业务系统。</s></li>
<li>✅<s>ringbuffer 模块需要自定义一个注解来实现业务子系统集成该模块后能扫描到该模块下的 bean。</s></li>
<li>✅<s>搭建回报模块，执行回报流程。</s></li>
<li>✅<s>实现委托撤单。</s></li>
<li>✅<s>融资买入回报业务处理器，需要实现 doRevert，并在 doHandle 中触发。</s></li>
<li>🔴融资买入回报业务处理器，需要集成 RingBuffer ，实现高性能异步队列处理回报请求。</li>
<li>🔴统一流水计数器考虑抽象成公共组件，供各业务子系统使用。</li>
<li>🔴普通业务头寸资金流水表，需要通过统一流水计数器获取序列号，同时考虑性能，序列号递增的写库操作考虑引入异步队列触发。</li>
</ul>
<h3 id="9-流水计数器种类">9. 流水计数器种类</h3>
<table>
<thead>
<tr>
<th>计数器编号</th>
<th>对应数据表名</th>
<th>单次申请步长</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>头寸账户资金流水表</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>信用交易委托表</td>
<td>100</td>
</tr>
<tr>
<td>2</td>
<td>客户专项头寸资金表</td>
<td>100</td>
</tr>
<tr>
<td>3</td>
<td>客户专项头寸资金表回滚专用</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>信用客户持仓流水表</td>
<td>1</td>
</tr>
</tbody>
</table>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://lemonhuang.com/tags/%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/">交易系统开发日志</a></span>
        
    </p>

      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://lemonhuang.com/categories/%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/">交易系统开发日志</a></span>
        
    </p>


      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        14078字
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2024-03-02
        

        
      </p>
    </div>

    

    

    

  </main>

            </div>

            
                <footer class="footer">
    

    
    <div>© 2023 - <span id="year"></span><br/></div>
    <div>网站已经运行 <span id="days">0</span></div>
    <div class="footer__inner">
        <div class="footer__content">
            <span><a href="http://beian.miit.gov.cn">浙ICP备19022115号-1</a></span>
        </div>        
        <script>
            var s0 = '2023-06-01';
            s1 = new Date(s0.replace(/-/g, "/"));
            s2 = new Date();
            var days = s2.getTime() - s1.getTime();

            var date = new Date;
            var year = date.getFullYear();
            document.getElementById('year').innerHTML = year;

            var BootDate = new Date(s0);
            function ShowRunTime(id) {
                var NowDate = new Date();
                var RunDateM = parseInt(NowDate - BootDate);
                var RunDays = Math.floor(RunDateM / (24 * 3600 * 1000));
                var RunHours = Math.floor(RunDateM % (24 * 3600 * 1000) / (3600 * 1000));
                var RunMinutes = Math.floor(RunDateM % (24 * 3600 * 1000) % (3600 * 1000) / (60 * 1000));
                var RunSeconds = Math.round(RunDateM % (24 * 3600 * 1000) % (3600 * 1000) % (60 * 1000) / 1000);
                var days = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
                document.getElementById(id).innerHTML = days;
            }
            ShowRunTime('days');
            setInterval("ShowRunTime('days')", 1000);
        </script>
    </div>
    
</footer>



            
        </div>

        



<script type="text/javascript" src="/bundle.min.644292943ae47eef02fcd64b11757aeb8caeeaebf473a823b62099edccac808e8d82689359f285e5d95994e5ad5ae3b9c1ccc281eb1828e67d0ba6630f95b832.js" integrity="sha512-ZEKSlDrkfu8C/NZLEXV664yu6uv0c6gjtiCZ7cysgI6NgmiTWfKF5dlZlOWtWuO5wczCgesYKOZ9C6ZjD5W4Mg=="></script>



    </body>
</html>
